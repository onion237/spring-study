# 4장. 예외



### 1.사라진 SQLException

jdbcContext를 jdbcTemplate로 전황하면서  throws SQLException이 사라졌다.

SQLException은 JDBC API 메소드들이 던져주는 것이므로 항상 있어야 한다.



#### 1.1 초난감 예외 처리

>  예외 처리의 핵심 원칙
>
> - 모든 예외는 적절하게 복구되거나.
> - 작업을 중단시키고 운영자에게 분명하게 통보해야 한다.

1. 예외 블랙홀

2. 무의미하고 무책임한 throws : 메소드 선언에 throws Exception 

   

#### 1-2. 예외의 종류와 특징

1. error

   * java.lang.Error 클래스의서브 클래스

   - 시스템데 비정상적 상황이 발생했을 경우 JVM단에서 발생

   - 어플리케이션 단에서 처리 불가

2. Exception/checked Exception
   * java.lang.Exception 클래스와 그 서브클래스로 정의되는 예외들
   * 어플리케이션 코드 작업 중 예외상황이 발생했을 경우
   * catch문으로 잡거나 throws 처리
3. uncehcked Exception
   * RuntimeException을 상속한 클래스들을 말한다.
   * 명시적인 예외처리를 강제하지 않음
   * 주로 프로그램의 오류가 있을 때 발생하도록 의도된 것들
   * NPE, IllegalAgrumentException등 피할 수 있지만, 개발자의 부주의로 인해 발생할 수 있는 에러



> JDK 초기 설계자들은 체크 예외를 통해 발생 가능한 모든 예외에 적용하려고 노력했던것 같으나 
> 최근에는 체크예외의 불필요성을 주장하는 의견이 많고, 자바 표준 스펙 API들은 가능한 체크 예외를 만들지 않는 경향



#### 1-3. 예외 처리 방법

1. 예외 복구
   예외상황을 파악하고, 문제를 해결해서 정상 상태로 돌려 놓는 것
   Exception 메세지를 사용자에 그대로 전달하지 않고 어플리케이션 단에서는 정상적인 흐름처럼 동작

2. 예외처리 회피
   예외처리를 자신이 담당하지 않고, 자신을 호출한 쪽으로 예외를 던져버리는 방식
   예로, 템플릿 콜백 패턴에서 콜백 오브젝트의 메소드는 SQLException에 대한 예외를 회피하고 템플릿 레벨에서 처리하도록 던져준다.

> 복구나 회피는 의도가 분명해야 한다.

3. 예외 전환

   * 예외를 메소드 밖으로 던지긴하지만, 회피와 달리 절적한 예외로 전환해서 던진다

     a. 중첩 예외 : 의미를 분명하게 해줄 수 있는 예외로 바꿔주기 위함

     b. 포장 예외 : 주로 예외처리를 강제하는 체크 예외를 언체크 예외의 런타임 예외로 바꾸는 경우에 사용

   

   >  비즈니스적으로도 의미가 없고, 복구 가능하지도 않은 예외에 대해서는 런타임 예외로 포장해서 던지는 편이 낫다. => 다른 계층의 메소드를 작성할 때 불필요한 throws 선언 방지
   > 단, 어플리케이션 로직으로 인한 예외는 체크 예외를 사용하는게 적절하다.

   

#### 1-4. 예외 처리 전략

1. 런타임 예외의 보편화
   * 자바환경이 서버환경으로 넘어가면서, 체크 예외의 활용도와 가치가 떨어진다.
     **서버 환경: 한번에 다수의 사용자가 접근하여 해당 서비스를 이용하기 때문에 작업을 중단하고 예외 상황을 복구할 수 없다.
   * 컴파일러가 예외처리를 강제하지 않으므로 신경쓰지 않으면 예외 상황을 충분히 고려하지 않게됨
   * 런타임 예외를 사용하는 경우에는 api문서, 레퍼런스 문서 등을 통해 메소드를 사용할 때 발생할 수 있는 예외의 종류와 원인, 활용 방법을 자세히 설명해야한다.
2. 애플리케이션 예외
   * 로직에 의한 예외로 반드시 catch문을 사용해서 조치를 취하도록 요구한다.



#### 1-5. SQLException은 어떻게 됐나?
코드 레벨에서 복구방법이 없는 경우에는 중첩 예외(예외 전환)을 통해 언체크 예외를 던져버리는 편이 낫다
비즈니스적으로 더 명확한 의미를 줄 수 있는 경우에는 포장 예외(예외 전환)을 통해 중첩 예외로 던져버리는 편이 낫다
SQLException은 대부분 SQL문법 오류, 제약조건 위반, DB서버 다운, 네트워크 불안정, DB커넥션 풀 등 복구 불가능한 상황이므로 런타임에러로 전환해야 한다. => jdbcTemplate 템플릿과 콜백 안에서 발생하는 모든 SQLException을 런타임 예외인 DataAccessException으로 포장해서 던져준다.



### 2. 예외 전환

> 예외 전환의 목적
>
> 1. 런타임 예외로 포장해서 굳이 필요하지 않은 catch/throws를 줄여주는 것
> 2. 로우레벨의 예외를 좀 더 의미있고 추상화된 예외로 바꾸어 던져주는 것

#### 2-1. JDBC의 한계

> JDBC의 Connection, Statement, ResultSet 등의 표준 인터페이스를 통해 그 기능을 제공하고, 개발자들은 표준화된 JDBC의 API를 사용하여 DB의 종류에 상관없이 일관된 방법으로 프로그래밍 할 수 있다.
>
> 하지만, DB종류에 관계 없이 사용할 수 있는 데이터 엑세스 코드를 작성하는 일은 쉽지 않다.

1. 비표준 SQL
   * SQL은 어느정도는 표준화 되어있지만, 대부분의 DB는 비표준 문법과 기능을 제공
   * 호환 가능한 표준 SQL만 사용하거나 / DB별로 별도의 DAO를 만들어 독립
2. 호환성 없는 SQLExecption의 DB 에러 정보
   * SQL 에러 종류가 다양함(문법오류, DB커넥션 실패, 키 중복, 제약조건 위반 등)
   * JDBC는 SQLException 하나에 모두 담아버린다.
   * SQLException의 getErrorCode()로 에러 코드를 가져올 수 있다 -> DB별로 에러코드도 다르다.

> SQL 상태 코드를 믿고 결과를 판단하기에는 위험하다. 
>
> 호환성없는 에러코드와 표준을 잘 따르지 않는 상태코드를 가진 SQLException만으로 DB에 독립적인 유연한 코드를 작성하는 것은 불가능에 가깝다.

#### 2-2. DB에러 코드 매핑을 통한 전환

* 스프링은 `DataAccessException` 의 서브클래스로 세분화된 예외클래스들을 정의하고 있다.

  * `BadSqlGrammarException` SQL 문법 에러

  * `DataAccessResourceFailureException` DB 커넥션 실패

  * `DataIntergrityViolationException` 데이터 제약조건 위배

  * `DuplicatedKeyException` 중복 키 발생

    

* SQLException에 담긴 SQL 상태 코드 < DB 전용 에러코드

​		하지만, DB마다 에러코드도 제각각이라는 문제가 있다.



> DB별 에러 코드를 분류해서 스프링이 정의한 예외 클래스와 매핑해놓은 에러 코드 매핑정보 테이블을 만들어두고 이를 이용한다.(리스트 4-16)
>
> 이렇게하면, 단순히 SQLException을 런타임 에러인 DataAccessException으로 포장만 하는 것이 아니라 DB의 에러 코드를 DataAccessException 계층구조의 클래스 중 하나로 매핑해준다.



#### 2-3. DAO 인터페이스와 DataAccessException 계층구조

`DataAccessException` 은 의미가 같은 예외라면 데이터 액세스 기술의 종류와 상관없이 일관된 예외가 발생하도록 만들어준다.

1. DAO 인터페이스와 구현의 분리
   * DAO는 인터페이스를 사용해 구체적인 클래스 정보와 구현방법은 감추고, DI를 통해 제공
2. 데이터 엑세스 예외 추상화와 DataAcessException 계층구조
   *  `DataAccessException` 은 JDBC뿐만 아니라 자바 데이터 액세스 기술에서 발생하는 예외에도 적용
   * 인터페이스 사용, 런타임 예외 전환과 함께 DataAccessException 예외 추상화를 적용하면 데이터 액세스 기술과 구현방법에 독립적인 이상적인 DAO를 만들 수 있다.

